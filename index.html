<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doon City Bus | Dehradun Smart Transit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }
        .bus-icon {
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .bus-icon.express {
            background: #ef4444;
        }
        .stop-marker {
            background: white;
            border: 2px solid #374151;
            border-radius: 50%;
        }
        .key { color: #9cdcfe; }
        .string { color: #ce9178; }
        .number { color: #b5cea8; }
        .boolean { color: #569cd6; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden font-sans">

    <header class="bg-gray-800 border-b border-gray-700 h-16 flex items-center justify-between px-6 shadow-lg z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-bus text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">Doon City <span class="text-green-400">Live</span></h1>
                <p class="text-xs text-gray-400">Dehradun Smart City Limited</p>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="app.toggleApiView()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded border border-gray-600 transition">
                <i class="fa-solid fa-code mr-2"></i>API Stream
            </button>
            <button onclick="app.resetSimulation()" class="text-sm bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded transition shadow-lg shadow-blue-900/50">
                <i class="fa-solid fa-rotate-right mr-2"></i>Reset Sim
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <aside class="w-full md:w-96 bg-gray-800 border-r border-gray-700 flex flex-col z-10 shadow-xl transition-transform duration-300 absolute md:relative h-full" id="sidebar">
            <div class="grid grid-cols-2 gap-2 p-4 border-b border-gray-700">
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-xs text-gray-400 uppercase">Active Vehicles</div>
                    <div class="text-2xl font-bold text-white" id="stat-vehicles">0</div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-xs text-gray-400 uppercase">Avg Speed</div>
                    <div class="text-2xl font-bold text-blue-400"><span id="stat-speed">0</span> <span class="text-sm font-normal text-gray-400">km/h</span></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <h2 class="text-xs font-bold text-gray-500 uppercase mb-3">Live Arrivals & ETAs</h2>
                <div id="vehicle-list" class="space-y-3"></div>
            </div>

            <div class="h-32 bg-black p-2 font-mono text-xs overflow-y-auto border-t border-gray-700 text-green-400" id="system-logs">
                <div>[SYSTEM] Initializing GPS ingestion stream...</div>
            </div>
        </aside>

        <div class="flex-1 relative bg-gray-900">
            <div id="map"></div>
            
            <div class="absolute bottom-6 left-6 bg-gray-800/90 backdrop-blur p-3 rounded-lg border border-gray-600 shadow-xl z-[500]">
                <div class="flex items-center gap-2 mb-1">
                    <span class="w-3 h-3 rounded-full bg-blue-500 border border-white"></span>
                    <span class="text-xs">Route 1: ISBT - Rajpur Road</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-orange-500 border border-white"></span>
                    <span class="text-xs">Route 2: Prem Nagar - Raipur</span>
                </div>
            </div>
        </div>

        <div id="api-overlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-10">
            <div class="bg-gray-900 w-full max-w-4xl h-3/4 rounded-xl border border-gray-700 shadow-2xl flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl">
                    <div class="flex items-center gap-2">
                        <span class="bg-green-500 text-black text-xs font-bold px-2 py-1 rounded">GET</span>
                        <span class="font-mono text-sm text-gray-300">/api/v1/vehicles/live</span>
                    </div>
                    <button onclick="app.toggleApiView()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-auto p-6 font-mono text-sm bg-[#1e1e1e]">
                    <pre id="api-output" class="whitespace-pre-wrap text-gray-300"></pre>
                </div>
            </div>
        </div>

    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const ROUTES = {
            blueLine: {
                id: 'route-isbt-rajpur',
                name: 'ISBT to Pacific Mall',
                color: '#3b82f6',
                stops: [
                    { name: "ISBT Dehradun", lat: 30.2856, lng: 77.9951 },
                    { name: "Railway Station", lat: 30.3140, lng: 78.0300 },
                    { name: "Clock Tower (Ghanta Ghar)", lat: 30.3244, lng: 78.0418 },
                    { name: "Dilaram Chowk", lat: 30.3350, lng: 78.0500 },
                    { name: "Pacific Mall / Jakhan", lat: 30.3650, lng: 78.0700 }
                ]
            },
            orangeLine: {
                id: 'route-prem-raipur',
                name: 'Prem Nagar to Raipur',
                color: '#f97316',
                stops: [
                    { name: "Prem Nagar", lat: 30.3360, lng: 77.9600 },
                    { name: "IMA", lat: 30.3300, lng: 77.9800 },
                    { name: "Ballupur Chowk", lat: 30.3350, lng: 78.0100 },
                    { name: "Clock Tower (Ghanta Ghar)", lat: 30.3244, lng: 78.0418 },
                    { name: "Parade Ground", lat: 30.3260, lng: 78.0450 },
                    { name: "Raipur Stadium", lat: 30.3050, lng: 78.0950 }
                ]
            }
        };

        function generatePath(stops) {
            let path = [];
            stops.forEach(s => path.push([s.lat, s.lng]));
            if(stops.length > 4) path.push([stops[0].lat, stops[0].lng]); 
            return path;
        }

        class Vehicle {
            constructor(id, routeKey, startProgress = 0) {
                this.id = id;
                this.routeKey = routeKey;
                this.route = ROUTES[routeKey];
                this.path = generatePath(this.route.stops);
                this.progress = startProgress; 
                this.speed = 0.0005 + (Math.random() * 0.0005);
                this.currentPos = [0,0];
                this.nextStop = null;
                this.eta = 0;
                this.status = "Moving";
                this.updatePosition();
            }

            update() {
                this.progress += this.speed;
                if (this.progress >= 1) this.progress = 0;

                this.updatePosition();
                this.calculateETA();
            }

            updatePosition() {
                const totalPoints = this.path.length - 1;
                const scaledProgress = this.progress * totalPoints;
                const currentIndex = Math.floor(scaledProgress);
                const nextIndex = (currentIndex + 1) % this.path.length;
                const segmentProgress = scaledProgress - currentIndex;

                const p1 = this.path[currentIndex];
                const p2 = this.path[nextIndex];

                const lat = p1[0] + (p2[0] - p1[0]) * segmentProgress;
                const lng = p1[1] + (p2[1] - p1[1]) * segmentProgress;
                
                this.currentPos = [lat, lng];
            }

            calculateETA() {
                const totalStops = this.route.stops.length;
                const stopsPerUnit = 1 / totalStops;
                let nextStopIndex = Math.floor(this.progress / stopsPerUnit) + 1;
                
                if (nextStopIndex >= totalStops) {
                    if (this.routeKey === 'blueLine') nextStopIndex = 0;
                    else nextStopIndex = totalStops - 1;
                }

                this.nextStop = this.route.stops[nextStopIndex];
                
                let distRemaining = (nextStopIndex * stopsPerUnit) - this.progress;
                if(distRemaining < 0) distRemaining += 1;
                
                this.eta = Math.ceil(distRemaining * 200); 

                if (this.eta < 5) this.status = "Arriving";
                else if (this.eta < 15) this.status = "Near";
                else this.status = "En Route";
            }

            toJSON() {
                return {
                    vehicle_id: this.id,
                    route: this.route.name,
                    lat: this.currentPos[0].toFixed(6),
                    lng: this.currentPos[1].toFixed(6),
                    speed_kmh: Math.floor(this.speed * 100000),
                    next_stop: this.nextStop.name,
                    eta_seconds: this.eta,
                    status: this.status,
                    timestamp: new Date().toISOString()
                };
            }
        }

        class TransportSystem {
            constructor() {
                this.map = null;
                this.vehicles = [];
                this.markers = {};
                this.isApiOpen = false;
            }

            init() {
                this.initMap();
                this.initVehicles();
                this.startSimulation();
            }

            initMap() {
                this.map = L.map('map').setView([30.3244, 78.0418], 13);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy;OpenStreetMap, &copy;CartoDB',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(this.map);

                this.drawRoute(ROUTES.blueLine);
                this.drawRoute(ROUTES.orangeLine);
            }

            drawRoute(route) {
                const points = generatePath(route.stops);
                
                L.polyline(points, {
                    color: route.color,
                    weight: 4,
                    opacity: 0.7,
                    dashArray: route.id === 'route-prem-raipur' ? '10, 10' : null
                }).addTo(this.map);

                route.stops.forEach(stop => {
                    L.circleMarker([stop.lat, stop.lng], {
                        radius: 5,
                        fillColor: '#fff',
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 1
                    }).bindPopup(`<b>${stop.name}</b><br>${route.name}`).addTo(this.map);
                });
            }

            initVehicles() {
                this.vehicles = [
                    new Vehicle('UK07-PA-2304', 'blueLine', 0.0),
                    new Vehicle('UK07-PA-1102', 'blueLine', 0.4),
                    new Vehicle('UK07-TC-0099', 'orangeLine', 0.1),
                    new Vehicle('UK07-TC-4501', 'orangeLine', 0.6)
                ];
            }

            startSimulation() {
                setInterval(() => {
                    this.updateState();
                    this.render();
                }, 1000);
            }

            updateState() {
                this.vehicles.forEach(v => v.update());
                
                if(Math.random() > 0.95) {
                    const v = this.vehicles[Math.floor(Math.random()*this.vehicles.length)];
                    this.log(`GPS update received for ${v.id}: Lat ${v.currentPos[0].toFixed(4)}`);
                }
            }

            render() {
                this.renderMapMarkers();
                this.renderDashboard();
                if(this.isApiOpen) this.renderApiView();
            }

            renderMapMarkers() {
                this.vehicles.forEach(v => {
                    if (!this.markers[v.id]) {
                        const iconClass = v.routeKey === 'orangeLine' ? 'bus-icon express' : 'bus-icon';
                        const iconHtml = v.routeKey === 'orangeLine' ? '<i class="fa-solid fa-bus"></i>' : '<i class="fa-solid fa-bus"></i>';
                        
                        const icon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="${iconClass}" style="width: 30px; height: 30px;">${iconHtml}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        this.markers[v.id] = L.marker(v.currentPos, {icon: icon}).addTo(this.map);
                        this.markers[v.id].bindPopup(`<b>${v.id}</b>`);
                    } else {
                        this.markers[v.id].setLatLng(v.currentPos);
                    }
                });
            }

            renderDashboard() {
                document.getElementById('stat-vehicles').innerText = this.vehicles.length;
                const avgSpeed = this.vehicles.reduce((acc, v) => acc + (v.speed * 100000), 0) / this.vehicles.length;
                document.getElementById('stat-speed').innerText = Math.floor(avgSpeed);

                const listContainer = document.getElementById('vehicle-list');
                listContainer.innerHTML = '';

                this.vehicles.forEach(v => {
                    const colorClass = v.routeKey === 'blueLine' ? 'border-l-4 border-blue-500' : 'border-l-4 border-orange-500';
                    const etaColor = v.eta < 30 ? 'text-red-400 animate-pulse' : 'text-green-400';
                    
                    const card = `
                        <div class="bg-gray-700/40 p-3 rounded border border-gray-600 ${colorClass} hover:bg-gray-700 transition cursor-pointer" onclick="app.focusVehicle('${v.id}')">
                            <div class="flex justify-between items-start mb-1">
                                <div class="font-bold text-sm">${v.id} <span class="text-xs font-normal text-gray-400 ml-1">(${v.route.name})</span></div>
                                <div class="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-300">${v.status}</div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500">Next Stop</div>
                                    <div class="text-sm font-medium text-gray-200">${v.nextStop.name}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-500">ETA</div>
                                    <div class="font-mono font-bold ${etaColor}">${v.eta}s</div>
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += card;
                });
            }

            renderApiView() {
                const data = {
                    status: "success",
                    meta: {
                        timestamp: Date.now(),
                        active_units: this.vehicles.length,
                        api_version: "v1.2"
                    },
                    data: this.vehicles.map(v => v.toJSON())
                };

                let json = JSON.stringify(data, null, 2);
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                json = json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });

                document.getElementById('api-output').innerHTML = json;
            }

            log(msg) {
                const console = document.getElementById('system-logs');
                const entry = document.createElement('div');
                entry.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
                console.insertBefore(entry, console.firstChild);
                if(console.children.length > 20) console.lastChild.remove();
            }

            toggleApiView() {
                this.isApiOpen = !this.isApiOpen;
                const overlay = document.getElementById('api-overlay');
                if(this.isApiOpen) {
                    overlay.classList.remove('hidden');
                    this.renderApiView();
                } else {
                    overlay.classList.add('hidden');
                }
            }

            resetSimulation() {
                this.log("System reset initiated...");
                this.vehicles = [];
                Object.values(this.markers).forEach(m => this.map.removeLayer(m));
                this.markers = {};
                this.initVehicles();
                this.render();
                this.log("System reset complete.");
            }

            focusVehicle(id) {
                const v = this.vehicles.find(veh => veh.id === id);
                if(v) {
                    this.map.flyTo(v.currentPos, 16, { duration: 1.5 });
                    this.log(`Operator focused tracking on ${id}`);
                }
            }
        }

        const app = new TransportSystem();
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>